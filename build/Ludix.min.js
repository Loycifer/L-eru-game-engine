!function(a){function b(){c.load.audio=function(a,b){c.system.expectedResources+=1;var d=new XMLHttpRequest,e=void 0===b?a.substr(0,a.lastIndexOf(".")):b;d.open("GET",c.system.resourcePath+c.system.soundPath+a+c.system.audioType,!0),d.responseType="arraybuffer",d.onload=function(){c.audio.context.decodeAudioData(d.response,function(b){c.sound[e]=b,c.system.loadedResources+=1,c.log("Loaded audio file "+a)},function(){c.alert("There was a problem loading "+a+".")})},d.send()},c.objects.soundFX=function(a){void 0===a&&alert("Error accessing soundbuffer "+a),this.buffer=a},c.objects.soundFX.prototype.play=function(){var a=c.audio.context.createBufferSource();a.buffer=c.sound[this.buffer];var b=c.audio.context.createPanner(),d=c.audio.context.createGain();b.connect(c.audio.soundFX),b.panningModel="equalpower",b.setPosition(0,0,0),d.connect(b),a.connect(d),a.start(0),c.log("playing sound")}}window.performance||(window.performance={}),window.performance.now||(window.performance.now=function(){return Date.now()}),Array.prototype.mapQuick=function(a){for(var b=this.length,c=0;b>c;c++)a(this[c],c);return this},Array.prototype.sortBy=function(a,b){var c=this.length;void 0===b&&(b=1);for(var d=0;c>d;d++)this[d]instanceof Array&&this[d].sortBy(a,b);this.sort(function(c,d){var e=+c[a],f=+d[a];return b*(e-f)})},Array.prototype.getRandomElement=function(){return Math.floor(Math.random()*this.length)},Array.prototype.removeElement=function(a){alert(2);var b=this.indexOf(a);return-1!==b&&(alert("removed "+this[b]),this.splice(b,1)),this},Array.prototype.draw=function(a){for(var b=this.length,c=0;b>c;c++)this[c]&&this[c].draw&&this[c].draw(a)},Array.prototype.update=function(a){for(var b=this.length,c=0;b>c;c++)this[c]&&this[c].update&&this[c].update(a)},Array.prototype.handleClick=function(a,b,c){for(var d=this.length,e=d-1;e>=0;e--)if(this[e].handleClick&&this[e].handleClick(a,b,c))return!0},Math.jordanCurve=function(a,b,c){for(var d=!1,e=c.length,f=0,g=e-1;e>f;g=f++)c[f][1]>b!=c[g][1]>b&&a<(c[g][0]-c[f][0])*(b-c[f][1])/(c[g][1]-c[f][1])+c[f][0]&&(d=!d);return d},Math.log10=function(a){return Math.log(a)/Math.LN10},Math.degToRad=function(a){return a*(Math.PI/180)},Math.radToDeg=function(a){return a*(180/Math.PI)},Math.vectorX=function(a,b){switch(b){case 0:return a;case 180:return-a;case 90:case-90:return 0;default:return Math.cos(Math.degToRad(b))*a}},Math.vectorY=function(a,b){switch(b){case 0:case 180:return 0;case 90:return-a;case-90:return a;default:return Math.sin(Math.degToRad(b))*a}},Math.Vector=function(a,b){this.magnitude=a,this.direction=b},Math.Vector.prototype.addVector=function(a){var b=Math.degToRad(this.direction),c=Math.degToRad(a.direction),d=Math.cos(b)*this.magnitude,e=Math.cos(c)*a.magnitude,f=-Math.sin(b)*this.magnitude,g=-Math.sin(c)*a.magnitude,h=d+e,i=f+g,j=Math.atan(i/h),k=Math.sqrt(Math.pow(h,2)+Math.pow(i,2));this.magnitude=k,this.direction=j},Math.rotatePoint=function(a,b,c){var d=Math.cos(c),e=Math.sin(c),f=d*a+e*b,g=-(e*a)+d*b;return{x:f,y:g}};var c={};c.system={},c.objects={},c.game={},c.pipe={},c.start=function(){var a=c.game,b=c.system;a.settings(),b.setup(),a.resources(),b.setLoadScreen(),function d(){var a=c.system,b=a.currentScene,e=a.now=window.performance.now(),f=a.dt=(a.now-a.then)/1e3;f>1/a.frameCap&&(a.dt=1/a.frameCap),a.then=e,b.update(f),b.draw(),requestAnimationFrame(d)}()},c.log=function(a){console&&console.log&&console.log(a)},c.alert=function(a){window&&window.alert&&window.alert(a)},c.system={},c.system.orientation="landscape",c.system.fullscreen=!0,c.system.canvasRatio=1,c.system.timeScale=1,c.system.frameCap=30,c.system.now,c.system.then=window.performance.now(),c.system.dt=0,c.system.resourcePath="resources/",c.system.soundPath="sounds/",c.system.texturePath="textures/",c.system.expectedResources=0,c.system.loadedResources=0,c.system.width=640,c.system.height=480,c.system.canvasLocation=document.body,Object.defineProperty(c.system,"centerX",{get:function(){return c.system.width/2}}),Object.defineProperty(c.system,"centerY",{get:function(){return c.system.height/2}}),c.system.layerAlpha=1,c.system.currentScene={},c.system.previousScene={},c.scenes={},c.texture={},c.load={},c.load.texture=function(a,b){c.system.expectedResources+=1;var d=new Image,e=void 0===b?a.substr(0,a.lastIndexOf(".")):b;return d.onload=function(){c.system.loadedResources+=1,console.log("Succesfully loaded texture "+a+"."),d.onload=void 0,d.error=void 0},d.onerror=function(){c.alert("Something went wrong loading texture file "+a+".")},d.src=c.system.resourcePath+c.system.texturePath+a,c.texture[e]=d,d.complete&&d.onload(),d},c.sound={},c.music={},window.addEventListener("load",c.start),c.system.renderCanvas=[],c.system.renderContext=[],c.system.bufferCanvas=[],c.system.bufferContext=[],c.system.fxCanvas=[],c.system.fxContext=[],c.system.pixelCanvas=[],c.system.pixelContext=[],c.system.setup=function(){function a(a){void 0!==c.system.currentScene.doKeyDown&&c.system.currentScene.doKeyDown(a)}function b(a){void 0!==c.system.currentScene.doKeyUp&&c.system.currentScene.doKeyUp(a)}{var d=c.system.width,e=c.system.height;c.system.aspectRatio=d/e}try{screen.lockOrientation(c.system.orientation)}catch(f){c.log("Warning: Screen orientation could not be locked.")}c.system.renderCanvas[0]=document.createElement("canvas"),c.system.renderCanvas[0].width=d,c.system.renderCanvas[0].height=e,c.system.canvasLocation.appendChild(c.system.renderCanvas[0]),c.system.renderContext[0]=c.system.renderCanvas[0].getContext("2d"),c.system.bufferCanvas[0]=document.createElement("canvas"),c.system.bufferCanvas[0].width=d,c.system.bufferCanvas[0].height=e,c.system.bufferContext[0]=c.system.bufferCanvas[0].getContext("2d"),c.system.fxCanvas[0]=document.createElement("canvas"),c.system.fxCanvas[0].width=d,c.system.fxCanvas[0].height=e,c.system.fxContext[0]=c.system.fxCanvas[0].getContext("2d"),c.system.pixelCanvas[0]=document.createElement("canvas"),c.system.pixelCanvas[0].width=1,c.system.pixelCanvas[0].height=1,c.system.pixelContext[0]=c.system.pixelCanvas[0].getContext("2d"),Object.defineProperty(c.system,"canvasX",{get:function(){return c.system.renderCanvas[0].offsetLeft}}),Object.defineProperty(c.system,"canvasY",{get:function(){return c.system.renderCanvas[0].offsetTop}}),c.mouse.setupEventListeners(),window.addEventListener("keydown",a,!0),window.addEventListener("keyup",b,!0),c.system.fullscreen&&(c.display.autoResize(),window.addEventListener("resize",c.display.autoResize,!0))},c.system.setLoadScreen=function(){var a=c.system,b=a.width,d=a.height,e=c.objects,f="#eeeeee",g=new e.Scene;g.bgFill="#000000";var h=new e.Textbox("Ludix",b/2,d/2-75);h.alignment="center",h.backgroundFill="",h.textFill=f,h.fontSize=50,h.autoSize();var i=new e.Textbox("https://github.com/Loycifer/Ludix.js",b/2,d/2);i.alignment="center",i.textFill=f,i.backgroundFill="",i.fontSize=20,i.visible=!1,i.autoSize(),g.layers.background.addObject(h);var j={state:"loading",timer:4};j.update=function(b){var d=this.timer;switch(this.state){case"loading":a.expectedResources===a.loadedResources&&(this.state="ready",i.visible=!0);break;case"ready":0>=d&&(this.timer=3,this.state="fadeOut"),k.alpha>0&&(k.alpha-=.5*b),k.alpha<0&&(k.alpha=0),l.alpha>0&&(l.alpha-=.5*b),l.alpha<0&&(l.alpha=0),this.timer-=1*b;break;case"fadeOut":0>=d&&c.game.main(),h.alpha>0&&(h.alpha-=1*b),h.alpha<0&&(h.alpha=0),i.alpha>0&&(i.alpha-=1*b),i.alpha<0&&(i.alpha=0),this.timer-=1*b}};var k={alpha:1};k.draw=function(c){var e=.25*b,g=a.loadedResources/a.expectedResources;c.globalAlpha=this.alpha,c.beginPath(),c.lineWidth=3,c.strokeStyle=f,c.fillStyle=f,c.rect(e,d/2,2*e,30),c.stroke(),c.fillRect(e+4,d/2+4,g*(2*e-8),22)},k.update=function(){};var l={alpha:1};l.draw=function(a){if(this.alpha>0){a.globalAlpha=this.alpha,a.lineWidth=1,a.strokeStyle="#000000",a.beginPath();for(var c=.5,e=d,f=b;e>c;c+=2)a.moveTo(0,c),a.lineTo(f,c);a.stroke()}},g.layers.background.addObject(k),g.layers.background.addObject(i),g.layers.background.addObject(j),g.layers.background.addObject(l),g.setScene()},c.mouse={},c.mouse.x=0,c.mouse.y=0,c.mouse.buttons=[],c.mouse.buttons[0]={name:"left",isDown:!1,lastDown:{x:0,y:0}},c.mouse.buttons[1]={name:"middle",isDown:!1,lastDown:{x:0,y:0}},c.mouse.buttons[2]={name:"right",isDown:!1,lastDown:{x:0,y:0}},c.mouse.touchEnabled=!1,c.mouse.reset=function(){for(var a=0;3>a;a++){var b=this.buttons[a];b.isDown=!1,b.lastDown.x=0,b.lastDown.y=0}},c.system.handleClick=function(a){var b=0,d=0,e=a.type;if(a.targetTouches){b=(a.targetTouches[0].pageX-c.system.canvasX)/c.system.canvasRatio,d=(a.targetTouches[0].pageY-c.system.canvasY)/c.system.canvasRatio;var f=c.mouse.buttons[0];"touchstart"===e&&(f.isDown=!0,f.lastDown.x=b,f.lastDown.y=d),"touchend"===e&&(f.isDown=!1)}else{var f=c.mouse.buttons[a.button];b=(a.pageX-c.system.canvasX)/c.system.canvasRatio,d=(a.pageY-c.system.canvasY)/c.system.canvasRatio,"mousedown"===e&&(f.isDown=!0,f.lastDown.x=b,f.lastDown.y=d),"mouseup"===e&&(f.isDown=!1)}c.system.currentScene.handleClick&&"left"===f.name&&c.system.currentScene.handleClick(b,d,a),a.preventDefault()},c.system.setMouseCoords=function(a){"touchmove"!==a.type?(c.mouse.x=(a.pageX-c.system.canvasX)/c.system.canvasRatio,c.mouse.y=(a.pageY-c.system.canvasY)/c.system.canvasRatio):(c.mouse.x=(a.targetTouches[0].pageX-c.system.canvasX)/c.system.canvasRatio,c.mouse.y=(a.targetTouches[0].pageY-c.system.canvasY)/c.system.canvasRatio)},c.mouse.setupEventListeners=function(){"ontouchstart"in document.documentElement?(c.mouse.touchEnabled=!0,c.system.renderCanvas[0].addEventListener("touchstart",c.system.handleClick),c.system.renderCanvas[0].addEventListener("touchmove",c.system.setMouseCoords),c.system.renderCanvas[0].addEventListener("touchend",c.system.handleClick)):(c.system.renderCanvas[0].addEventListener("mousedown",c.system.handleClick),c.system.renderCanvas[0].addEventListener("mousemove",c.system.setMouseCoords),c.system.renderCanvas[0].addEventListener("mouseup",c.system.handleClick))},c.display={get width(){return c.system.renderCanvas[0].style.offsetWidth},set width(a){c.system.renderCanvas[0].style.width=a},get height(){return c.system.renderCanvas[0].style.height},set height(a){c.system.renderCanvas[0].style.height=a}},c.display.autoResize=function(){var a=window.innerWidth,b=window.innerHeight,d=c.system.width,e=c.system.height,f=a/b;f>=c.system.aspectRatio?c.system.canvasRatio=b/e:f<c.system.aspectRatio&&(c.system.canvasRatio=a/d),c.system.renderCanvas[0].style.width=d*c.system.canvasRatio+"px",c.system.renderCanvas[0].style.height=e*c.system.canvasRatio+"px",document.body.style.width="100%",document.body.style.height=Math.floor(b)+"px"},c.system.checkAudio=function(){var a=document.createElement("audio");a.canPlayType("audio/ogg")?(c.system.audioType=".ogg",c.log("Using .ogg files")):a.canPlayType("audio/mp4")?(c.system.audioType=".m4a",c.log("Using .m4a files")):a.canPlayType("audio/wav")?(c.system.audioType=".wav",c.log("Using .wav files")):c.alert("Your browser doesn't support .wav, .ogg, or .m4a audio files.")},c.system.checkAudio(),c.audio={},c.audio.context={};try{window.AudioContext=window.AudioContext||window.webkitAudioContext,c.audio.context=new AudioContext,c.audio.compressor=c.audio.context.createDynamicsCompressor(),c.audio.compressor.connect(c.audio.context.destination),c.audio.masterGain=c.audio.context.createGain(),c.audio.masterGain.connect(c.audio.compressor),c.audio.masterGain.gain.value=1,c.audio.soundFX=c.audio.context.createGain(),c.audio.soundFX.connect(c.audio.masterGain),b()}catch(d){alert("Web Audio API is not supported in this browser")}c.objects.Sprite=function(a,b){this.animations={idle:[]},this.animations.idle[0]={img:c.texture[a],length:1e3},this.animations.idle[0].img&&c.log("Created Sprite from texture '"+a+"'."),this.texture=c.texture[a],this.texture&&this.texture.width>0&&(this.width=this.texture.width,this.height=this.texture.height,c.log("Setting Sprite dimensions to "+this.width+" by "+this.height+".")),this.handle={x:0,y:0},this.offset={x:0,y:0},this.scale={x:1,y:1};for(var d in b)b.hasOwnProperty(d)&&(c.log("Adding property "+d+" to Sprite object with with value "+JSON.stringify(b[d])+"."),this[d]=b[d]);Object.defineProperty(this,"center",{get:function(){return{x:this.width/2,y:this.height/2}}.bind(this)}),this.nudeTop=0,this.nudeLeft=0,this.nudeRight=this.nudeLeft+this.width,this.nudeBottom=this.nudeTop+this.height,this.nudeTopLeft=[this.nudeLeft,this.nudeTop],this.nudeTopRight=[this.nudeRight,this.nudeTop],this.nudeBottomLeft=[this.nudeLeft,this.nudeBottom],this.nudeBottomRight=[this.nudeRight,this.nudeBottom],this.nudeVertices=[this.nudeTopLeft,this.nudeTopRight,this.nudeBottomRight,this.nudeBottomLeft],this.vertices=new Array(this.nudeVertices.length),this.rotationAccel=0,this.accelDirection=0,this.nextX=this.x,this.nextY=this.y,this.nextSpeedX=this.speedX,this.nextSpeedY=this.speedY,this.wrapX=!0,this.wrapY=!1,this.boundingType="rect",this.blendMode="",this.onClick=function(){},this.currentAnimation="idle",this.currentFrame=0,this.animationTimer,this.updateCommands={},this.drawCommands={},this.gravity=0,this.g=1e3,this.direction=-Math.PI/2,this.v=0,this.y0=500-this.y,this.energy=this.y0,this.time=0,this.bounces=0,this.landingTime=(this.v*Math.sin(this.direction)+Math.sqrt(Math.pow(this.v*Math.sin(this.direction),2)+2*this.g*this.y0))/this.g},c.objects.Sprite.prototype.x=0,c.objects.Sprite.prototype.y=0,c.objects.Sprite.prototype.z=0,c.objects.Sprite.prototype.width=0,c.objects.Sprite.prototype.height=0,c.objects.Sprite.prototype.angle=0,c.objects.Sprite.prototype.rotation=0,c.objects.Sprite.prototype.alpha=1,c.objects.Sprite.prototype.speedX=0,c.objects.Sprite.prototype.speedY=0,c.objects.Sprite.prototype.accelX=0,c.objects.Sprite.prototype.accelY=0,c.objects.Sprite.prototype.visible=!0,c.objects.Sprite.prototype.isClickable=!0,c.objects.Sprite.prototype.setHandleXY=function(a,b){this.handle={x:a,y:b}},c.objects.Sprite.prototype.setScale=function(a){this.scale={x:a,y:a}},c.objects.Sprite.prototype.multiplyScale=function(a){this.scale={x:a*this.scale.x,y:a*this.scale.y}},c.objects.Sprite.prototype.flipHorizontal=function(){this.scale.x*=-1},c.objects.Sprite.prototype.flipVertical=function(){this.scale.y*=-1},c.objects.Sprite.prototype.getWorldX=function(){return this.x},c.objects.Sprite.prototype.getWorldY=function(){return this.y},c.objects.Sprite.prototype.getScreenX=function(){var a=c.system.currentScene;return this.x-a.camera.x*a.activeLayer.scrollRateX},c.objects.Sprite.prototype.getScreenY=function(){var a=c.system.currentScene;return this.y-a.camera.y*a.activeLayer.scrollRateY},c.objects.Sprite.prototype.autoDraw=function(a){if(this.visible&&!(this.alpha<=0)){var b=this.angle,c=this.getScreenX(),d=this.getScreenY(),e=this.scale;a.globalAlpha=this.alpha,a.save(),a.translate(c,d),a.scale(e.x,e.y),a.rotate(-b),a.drawImage(this.animations[this.currentAnimation][this.currentFrame].img,-this.handle.x,-this.handle.y),a.restore()}},c.objects.Sprite.prototype.draw=c.objects.Sprite.prototype.autoDraw,c.objects.Sprite.prototype.autoDrawCustom=function(a,b){a.globalAlpha=b&&void 0!==b.opacity?b.opacity:this.alpha,this.alpha>0&&this.visible&&(0!==this.angle?(a.save(),a.translate(this.x,this.y),a.rotate(-this.angle),a.drawImage(b&&void 0!==b.texture?b.texture:this.animations.idle[this.currentFrame].img,-this.handle.x,-this.handle.y),a.restore()):a.drawImage(b&&void 0!==b.texture?b.texture:this.animations.idle[this.currentFrame].img,this.x-this.handle.x,this.y-this.handle.y))},c.objects.Sprite.prototype.drawBoundingBox=function(a){a.beginPath(),this.getVertices(),a.moveTo(this.vertices[3][0],this.vertices[3][1]);for(var b=0;4>b;b++)a.lineTo(this.vertices[b][0],this.vertices[b][1]);a.closePath(),a.strokeStyle="#FFFFFF",a.lineWidth=2,a.stroke()},c.objects.Sprite.prototype.update2=function(a){this.autoUpdate(a)},c.objects.Sprite.prototype.autoUpdate=function(a){var b=c.system.timeScale;this.speedX+=this.accelX*a*b,this.speedY+=this.accelY*a*b,this.x+=this.speedX*a*b,this.y+=this.speedY*a*b,this.rotation+=this.rotationAccel*a*b,this.angle+=this.rotation*a*b},c.objects.Sprite.prototype.handleClick=function(a,b,c){if(this.isClickable){var d=this.scale,e=this.getScreenX(),f=this.getScreenY();if(0===this.angle){var g=e+this.offset.x-d.x*this.handle.x,h=g+d.x*this.width,i=f+this.offset.y-d.y*this.handle.y,j=i+d.y*this.height;if(g>h){var k=g;g=h,h=k}if(i>j){var k=i;i=j,j=k}if(a>=g&&h>=a&&b>=i&&j>=b&&this.isClickedPrecise(a,b)&&"mousedown"===c.type)return this.onClick(a,b,c),!0}else if(0!==this.angle&&Math.jordanCurve(a,b,this.getVertices())&&this.isClickedPrecise(a,b))return this.onClick(),!0}},c.objects.Sprite.prototype.isClickedPrecise=function(a,b){var d=c.system.pixelContext[0];d.clearRect(-1,-1,3,3),d.save(),d.translate(-a,-b),this.autoDraw(d),d.restore();var e=d.getImageData(0,0,1,1).data;return 0!==e[3]},c.objects.Sprite.prototype.getSpeedX=function(){return Math.vectorX(this.speed,this.direction)},c.objects.Sprite.prototype.getSpeedY=function(){return Math.vectorY(this.speed,this.direction)},c.objects.Sprite.prototype.applyForce=function(a,b){var c=this.getSpeedX(),d=this.getSpeedY(),e=Math.vectorX(a,b),f=Math.vectorY(a,b),g=c+e,h=d+f,i=Math.pow(Math.pow(g,2)+Math.pow(h,2),.5),j=Math.radToDeg(Math.atan2(-h,g));this.direction=j,this.speed=i},c.objects.Sprite.prototype.moveTo=function(a){this.x=a.x,this.y=a.y},c.objects.Sprite.prototype.moveToX=function(a){this.x=a},c.objects.Sprite.prototype.move=function(a){this.x+=a.x,this.y+=a.y},c.objects.Sprite.prototype.moveX=function(a){this.move({x:a,y:0})},c.objects.Sprite.prototype.moveY=function(a){this.move({x:0,y:a})},c.objects.Sprite.prototype.centerHandle=function(){this.handle={x:this.center.x,y:this.center.y}},c.objects.Sprite.prototype.pushProperties=function(a,b){for(var c=b.length,d=0;c>d;d++)a[b[d]]=this[b[d]]},c.objects.Sprite.prototype.pushPosition=function(a){a.x=this.x,a.y=this.y,a.offset={x:this.offset.x,y:this.offset.y}},c.objects.Sprite.prototype.getVertices=function(){var a=window.Math,b=this.getScreenX()+this.offset.x,c=this.getScreenY()+this.offset.y,d=this.nudeVertices.length,e=this.angle,f=this.scale;if(0!==e)for(var g=0;d>g;g++)this.vertices[g]=[(this.nudeVertices[g][0]-this.handle.x)*a.cos(-e)-(this.nudeVertices[g][1]-this.handle.y)*a.sin(-e),(this.nudeVertices[g][0]-this.handle.x)*a.sin(-e)+(this.nudeVertices[g][1]-this.handle.y)*a.cos(-e)];else for(var g=0;d>g;g++)this.vertices[g]=[this.nudeVertices[g][0]-this.handle.x,this.nudeVertices[g][1]-this.handle.y];return this.vertices.mapQuick(function(a){a[0]=a[0]*f.x+b,a[1]=a[1]*f.y+c}),this.vertices},c.Frame=function(a,b){this.img=c.texture[a],this.length=b},c.Animation=function(){},c.objects.Sprite.prototype.experimentalUpdate=function(a){var b=b;this.time+=a*b.system.timeScale;var c=c;this.time>=this.landingTime&&(this.energy<1&&(this.energy=0),this.direction=c.PI/2,this.y0=0,this.v=c.sqrt(2*this.g*this.energy/c.pow(c.sin(this.direction),2)),this.time-=this.landingTime,this.landingTime=(this.v*c.sin(this.direction)+c.sqrt(c.pow(this.v*c.sin(this.direction),2)+2*this.g*this.y0))/this.g),this.y=this.landingTime<a*b.system.timeScale?500:500-this.y0-(this.v*c.sin(this.direction)*this.time-this.g*this.time*this.time/2),this.y>=500&&(this.y=500),this.nextY=this.y,this.nextSpeedX+=this.accelX*a*b.system.timeScale,this.nextX+=this.nextSpeedX*b.system.dt*b.system.timeScale,this.nextX>=800&&(this.nextSpeedX=-this.speedX,this.speedX=-this.speedX,this.nextX=799),this.nextX<=49&&(this.nextSpeedX=-this.speedX,this.speedX=-this.speedX,this.nextX=50),this.x=this.nextX,this.speedX=this.nextSpeedX},c.objects.Layer=function(a){this.name=a,this.sorted=!1,this.sortBy=["z"],this.sortOrder=[1],this.objects=[],this.targetContext=c.system.bufferContext[0],this.layerAlpha=1,this.isClickable=!0,this.scrollRateX=1,this.scrollRateY=1},c.objects.Layer.prototype.draw=function(){this.autoDraw()},c.objects.Layer.prototype.autoDraw=function(){this.objects.draw(this.targetContext)},c.objects.Layer.prototype.update=function(a){this.autoUpdate(a)},c.objects.Layer.prototype.autoUpdate=function(a){if(this.objects.update(a),this.sorted){length=this.sortBy.length;for(var b=0;b<length;b++)this.objects.sortBy(this.sortBy[b],this.sortOrder[b])}},c.objects.Layer.prototype.handleClick=function(a,b,c){this.isClickable&&this.objects.handleClick(a,b,c)},c.objects.Layer.prototype.addObject=function(a){this.objects.push(a)},c.objects.Layer.prototype.addObjects=function(){for(var a=arguments.length,b=0;a>b;b++)this.addObject(arguments[b])},c.objects.Scene=function(a){this.name=a,c.scenes[a]=this,this.layers={background:new c.objects.Layer("background")},this.layerOrder=["background"],this.bgFill="blueviolet",this.motionBlur=1,this.keymap={},this.activeLayer={},this.camera={x:0,y:0,angle:0,zoom:1}},c.objects.Scene.prototype.update=function(a){return this.autoUpdate(a),this},c.objects.Scene.prototype.doKeyDown=function(a){void 0!==this.keymap.doKeyDown&&this.keymap.doKeyDown(a)},c.objects.Scene.prototype.doKeyUp=function(a){void 0!==this.keymap.doKeyUp&&this.keymap.doKeyUp(a)},c.objects.Scene.prototype.autoUpdate=function(a){for(var b=this.layerOrder,c=b.length,d=0;c>d;d++){var e=this.layers[b[d]];this.activeLayer=e,e.update(a)}return this},c.objects.Scene.prototype.autoDraw=function(){var a=c.system,b=a.bufferContext[0],d=a.renderContext[0],e=a.width,f=a.height;b.fillStyle=this.bgFill,b.fillRect(0,0,e,f);for(var g=this.layerOrder,h=g.length,i=0;h>i;i++){var j=this.layers[g[i]];this.activeLayer=j,j.draw()}b.globalAlpha=1,d.globalAlpha=this.motionBlur,d.drawImage(a.bufferCanvas[0],0,0,e,f)},c.objects.Scene.prototype.draw=c.objects.Scene.prototype.autoDraw,c.objects.Scene.prototype.addLayer=function(a){var b=new c.objects.Layer(a);return this.layers[a]=b,this.layerOrder.push(a),b},c.objects.Scene.prototype.addLayerObject=function(a){this.layers[a.name]=a,this.layerOrder.push(a.name)},c.objects.Scene.prototype.addObjectToLayer=function(a,b){return this.layers[b].addObject(a),this},c.objects.Scene.prototype.handleClick=function(a,b,c){for(var d=this.layerOrder,e=d.length,f=0;e>f;f++){var g=this.layers[d[f]];this.activeLayer=g,g.handleClick(a,b,c)}},c.objects.Scene.prototype.transition={},c.objects.Scene.prototype.transition.fadeToColor=function(a,b,d,e,f,g){c.transitions.fadeToColor.play(c.system.currentScene,a,b,d,e,f,g)},c.objects.Scene.prototype.transition.fadeToBlack=function(a,b,d,e,f){c.transitions.fadeToColor.play(c.system.currentScene,a,b,d,e,"#000000",f)},c.objects.Scene.prototype.transition.instant=function(a,b){c.transitions.instant.play(c.system.currentScene,a,b)},c.objects.Scene.prototype.setScene=function(){var a=c.system;return a.previousScene=a.currentScene,a.currentScene=this,this},c.objects.Textbox=function(a,b,c,d,e){this.width=void 0===d?200:d,this.height=e,this.words=void 0===a?[]:a.split(" "),this.textArray=[],Object.defineProperty(this,"text",{set:function(a){this.words=a.split(" "),this.wrapText()}.bind(this),get:function(){return this.words.join(" ")}.bind(this)}),this.x=void 0===b?0:b,this.y=void 0===c?0:c,this.alpha=1,this.font="Times",this.fontSize=30,this.lineSpacing=1,this.handle={},this.handle.x=0,this.handle.y=0,this.angle=0,this.speedX=0,this.speedY=0,this.accelX=0,this.accelY=0,this.rotation=0,this.textFill="#000000",this.wrap=!0,this.alignment="left",this.alignmentY="top",this.backgroundFill="#FFFFFF",this.borderFill="",this.borderWidth=0,this.marginLeft=5,this.marginTop=5,this.marginRight=5,this.marginBottom=5,this.visible=!0,this.isClickable=!0},c.objects.Textbox.prototype.draw=function(a){this.autoDraw(a)},c.objects.Textbox.prototype.autoDraw=function(a){if(this.visible){a.globalAlpha=this.alpha;var b=""!==this.backgroundFill&&this.borderWodth>0;a.textAlign="left",a.font=this.fontSize+"px "+this.font,this.height||(this.height=this.fontSize);var c=this.textArray.length;if(0!==this.angle){var d=this.angle;a.save(),a.translate(this.x,this.y),a.rotate(-d),b&&(a.beginPath(),a.rect(-this.handle.x,-this.handle.y,this.width+this.marginLeft+this.marginRight,this.height+this.marginTop+this.marginBottom+this.fontSize*(c-1)*this.lineSpacing),""!==this.backgroundFill&&(a.fillStyle=this.backgroundFill,a.fill()),this.borderWidth>0&&(a.strokeStyle=this.borderFill,a.lineWidth=this.borderWidth,a.stroke())),a.fillStyle=this.textFill,a.textBaseline="bottom";for(var e=0;c>e;e++)a.fillText(this.textArray[e],this.marginLeft-this.handle.x,this.marginTop+this.fontSize-this.handle.y+this.fontSize*e*this.lineSpacing);a.restore()}else{b&&(a.beginPath(),a.rect(this.x-this.handle.x,this.y-this.handle.y,this.width+this.marginLeft+this.marginRight,this.height+this.marginTop+this.marginBottom+this.fontSize*(c-1)*this.lineSpacing),""!==this.backgroundFill&&(a.fillStyle=this.backgroundFill,a.fill()),this.borderWidth>0&&(a.strokeStyle=this.borderFill,a.lineWidth=this.borderWidth,a.stroke())),a.fillStyle=this.textFill,a.textBaseline="bottom";for(var e=0;c>e;e++)a.fillText(this.textArray[e],this.x+this.marginLeft-this.handle.x,this.y+this.marginTop+this.fontSize-this.handle.y+this.fontSize*e*this.lineSpacing)}}},c.objects.Textbox.prototype.update=function(a){this.autoUpdate(a)},c.objects.Textbox.prototype.autoUpdate=function(){},c.objects.Textbox.prototype.autoSize=function(){this.autoSizeX(),this.autoSizeY(),this.wrapText()},c.objects.Textbox.prototype.autoSizeX=function(){this.width=this.getTextWidth(),this.realign()},c.objects.Textbox.prototype.autoSizeY=function(){this.height=this.fontSize},c.objects.Textbox.prototype.wrapText=function(){var a=this.words.length;this.textArray=[];for(var b=0,c="",d=this.width,e=0;a>e;e++){var f=this.getTextWidth(c);0===f?c=this.words[e]:this.getTextWidth(c+" "+this.words[e])<=d?c+=" "+this.words[e]:(this.textArray[b]=c,b++,c=this.words[e])}this.textArray[b]=c},c.objects.Textbox.prototype.getTextWidth=function(a){var b=c.system.bufferContext[0];if(b.font=this.fontSize+"px "+this.font,""===a)return 0;var d=b.measureText(a?a:this.text);return d.width},c.objects.Textbox.prototype.getTotalWidth=function(){return this.width+this.marginLeft+this.marginRight},c.objects.Textbox.prototype.getTotalHeight=function(){return this.height+this.marginTop+this.marginBottom},c.objects.Textbox.prototype.realign=function(){this[this.alignment](),this[this.alignmentY]()},c.objects.Textbox.prototype.center=function(){return this.handle.x=this.getTotalWidth()/2,this.alignment="center",this},c.objects.Textbox.prototype.centerY=function(){return this.handle.y=this.getTotalHeight()/2,this.alignmentY="centerY",this},c.objects.Textbox.prototype.top=function(){return this.handle.y=0,this.alignmentY="top",this},c.objects.Textbox.prototype.bottom=function(){return this.handle.y=this.getTotalHeight(),this.alignmentY="bottom",this},c.objects.Textbox.prototype.left=function(){return this.handle.x=0,this.alignment="left",this},c.objects.Textbox.prototype.right=function(){return this.handle.x=this.getTotalWidth(),this.alignment="right",this},c.objects.Textbox.prototype.setMargins=function(){switch(arguments.length){case 1:this.marginLeft=this.marginTop=this.marginRight=this.marginBottom=arguments[0];break;case 2:this.marginTop=this.marginBottom=arguments[0],this.marginLeft=this.marginRight=arguments[1];break;case 3:this.marginTop=arguments[0],this.marginRight=this.marginLeft=arguments[1],this.marginBottom=arguments[2];break;case 4:this.marginTop=arguments[0],this.marginRight=arguments[1],this.marginBottom=arguments[2],this.marginLeft=arguments[3];break;default:alert("Textbox.setMargins() called with wrong number of arguments.")}return this.realign(),this},c.objects.Textbox.prototype.handleClick=function(a,b){return this.isClickable&&(0===this.angle&&a>=this.x-this.handle.x&&a<=this.x+this.width+this.marginLeft+this.marginRight-this.handle.x&&b>=this.y-this.handle.y&&b<=this.y+this.height+this.marginTop+this.marginBottom-this.handle.y+this.fontSize*(this.textArray.length-1)*this.lineSpacing||0!==this.angle&&Math.jordanCurve(a,b,this.getVertices()))?(this.onClick(),!0):void 0},c.objects.Textbox.prototype.getVertices=function(){var a=window.Math,b=this.x,c=this.y,d=0-this.handle.y,e=0-this.handle.x,f=e+this.width+this.marginLeft+this.marginRight,g=d+this.height+this.marginTop+this.marginBottom+this.fontSize*(this.textArray.length-1)*this.lineSpacing,h=[[e,d],[f,d],[f,g],[e,g]];if(0!==this.angle)for(var i=h.length,j=0;i>j;j++)h[j]=[h[j][0]*a.cos(-this.angle)-h[j][1]*a.sin(-this.angle),h[j][0]*a.sin(-this.angle)+h[j][1]*a.cos(-this.angle)];return h.mapQuick(function(a){a[0]+=b,a[1]+=c}),h},c.transitions={},c.transitions.instant={},c.transitions.instant.play=function(a,b,d){a.exit&&a.exit(),d&&d(b),c.system.currentScene=b},c.transitions.fadeToColor={lastScene:{},nextScreen:{},timer:0,state:"start"},c.transitions.fadeToColor.play=function(a,b,d,e,f,g,h){this.lastScene=a,this.nextScene=b,this.camera=a.camera,this.currentScene=a,this.activeLayer=a.activeLayer,this.fadeOut=d,this.pause=e,this.fadeIn=f,this.timer=d,this.state="start",this.color=g||"#000000",this.callback=h||function(){},c.system.currentScene=this},c.transitions.fadeToColor.update=function(a){switch(this.state){case"start":this.timer=this.fadeOut,this.lastScene.update(a),this.state="fadeOut";break;case"fadeOut":this.timer-=a,this.lastScene.update(a),this.timer<=0&&(this.timer=this.pause,this.callback(this.nextScene),this.state="pause");break;case"pause":this.timer-=a,this.timer<=0&&(this.camera=this.nextScene.camera,this.timer=this.fadeIn,this.state="fadeIn");break;case"fadeIn":this.timer-=a,this.nextScene.update(a),this.timer<=0&&(c.system.currentScene=this.nextScene);break;default:alert("Hey!")}},c.transitions.fadeToColor.draw=function(){switch(this.state){case"start":case"fadeOut":this.lastScene.draw(),c.system.renderContext[0].fillStyle=this.color,c.system.renderContext[0].globalAlpha=1-this.timer/this.fadeOut,c.system.renderContext[0].fillRect(0,0,c.system.width,c.system.height);break;case"pause":c.system.renderContext[0].fillStyle=this.color,c.system.renderContext[0].globalAlpha=1,c.system.renderContext[0].fillRect(0,0,c.system.width,c.system.height);break;case"fadeIn":this.nextScene.draw(),c.system.renderContext[0].fillStyle=this.color,c.system.renderContext[0].globalAlpha=this.timer/this.fadeIn,c.system.renderContext[0].fillRect(0,0,c.system.width,c.system.height);break;default:alert("hey!")}},c.input={},c.input.keyCodeFromString=function(a){var b=a.toUpperCase().replace(" ","");if(b.match(/^[A-Z0-9]$/))return b.charCodeAt(0);if(0===b.indexOf("NUMPAD"))return 96+parseInt(b.charAt(b.length-1));if(0===b.indexOf("F"))return 111+parseInt(b.replace("F",""));switch(b){case"MULTIPLY":return 106;case"ADD":return 107;case"ENTER":return 13;case"SUBTRACT":return 109;case"DECIMAL":return 110;case"DIVIDE":return 111;case"BACKSPACE":case"BACK":return 8;case"TAB":return 9;case"SHIFT":return 16;case"CONTROL":case"CTRL":return 17;case"CAPS":case"CAPSLOCK":return 20;case"ESC":case"ESCAPE":return 27;case"SPACE":case"SPACEBAR":return 32;case"PGUP":case"PAGEUP":return 33;case"PGDN":case"PAGEDOWN":return 34;case"END":return 35;case"HOME":return 36;case"LEFT":case"LEFTARROW":return 37;case"UP":case"UPARROW":return 38;case"RIGHT":case"RIGHTARROW":return 39;case"DOWN":case"DOWNARROW":return 40;case"INSERT":return 45;case"DELETE":return 46;case"NUMLOCK":return 144;case"SCRLK":case"SCROLLLOCK":return 145;case"PAUSE":case"PAUSEBREAK":return 19;case";":case":":return 186;case"=":case"+":return 187;case"-":case"_":return 198;case"/":case"?":return 191;case"~":case"`":return 192;case"[":case"{":return 219;case"\\":case"|":case"BACKSLASH":return 220;case"]":case"}":return 221;case"'":case'"':case"QUOTE":case"QUOTES":return 222;case",":case"<":return 188;case".":case">":return 190;default:alert("'"+a+"' is not a valid key identifier.")}},c.input.Keymap=function(){this.bindings={}},c.input.Keymap.prototype.doKeyDown=function(a){var b=a.keyCode,c=this.bindings;c[b]&&c[b].keydown&&c[b].keydown()},c.input.Keymap.prototype.doKeyUp=function(a){var b=a.keyCode,c=this.bindings;
c[b]&&c[b].keyup&&c[b].keyup()},c.input.Keymap.prototype.bindKey=function(a,b,d){this.bindKeyCode(c.input.keyCodeFromString(a),b,d)},c.input.Keymap.prototype.bindKeyCode=function(a,b,c){this.bindings[a]||(this.bindings[a]={}),this.bindings[a][b]=c},c.objects.Bone=function(a,b){c.objects.Sprite.call(this,a,b),this.inheritPosition=!0,this.inheritAngle=!0,this.inheritScale=!0,this.joint={x:0,y:0},this.relAngle=0,this.children=[]},c.objects.Bone.prototype=new c.objects.Sprite,c.objects.Bone.constructor=c.objects.Bone,c.objects.Bone.prototype.draw=function(a){this.autoDraw(a)},c.objects.Bone.prototype.updateBone=function(a){var b=this.parent;if(this.inheritScale){var c=b.scale;this.scale={x:c.x,y:c.y}}if(this.inheritPosition){var d=b.x,e=b.y,f=this.parent.scale,g=this.joint.x-b.handle.x,h=this.joint.y-b.handle.y;if(0===b.angle)this.x=d+f.x*(this.joint.x-b.handle.x),this.y=e+f.y*(this.joint.y-b.handle.y);else{var i=Math.rotatePoint(g,h,this.parent.angle);this.x=i.x*f.x+d,this.y=i.y*f.y+e}}this.inheritAngle&&(this.angle=this.relAngle+b.angle);for(var j=this.children.length,k=0;j>k;k++)this.children[k].updateBone(a),this.children[k].update(a)},c.objects.Skeleton=function(a,b){c.objects.Sprite.call(this,a,b),this.children=[],this.bones={},this.drawOrder=[this]},c.objects.Skeleton.prototype=new c.objects.Sprite,c.objects.Skeleton.constructor=c.objects.Skeleton,c.objects.Skeleton.prototype.handleClick=function(a,b,d){for(var e=this.drawOrder.length,f=e-1;f>=0;f--){var g,h=this.drawOrder[f];if(g=this!==h?h.handleClick(a,b,d):c.objects.Sprite.prototype.handleClick.call(this.drawOrder[f],a,b,d))return!0}},c.objects.Skeleton.prototype.addBone=function(a,b){var d=new c.objects.Bone(a);return d.name=b,d.master=this,d.parent=this,this.children.push(d),this.bones[b]=d,this.drawOrder.push(d),d},c.objects.Bone.prototype.addBone=function(a,b){var d=new c.objects.Bone(a);return d.name=b,d.master=this.master,d.parent=this,this.children.push(d),this.master.bones[b]=d,this.master.drawOrder.push(d),d},c.objects.Skeleton.prototype.draw=function(a){for(var b=this.drawOrder.length,c=0;b>c;c++){var d=this.drawOrder[c];this===d?(this.autoDraw(a),this.drawBoundingBox(a)):this.drawOrder[c].draw(a)}},c.objects.Skeleton.prototype.update=function(a){this.updateBones(a)},c.objects.Skeleton.prototype.updateBones=function(a){for(var b=this.children.length,c=0;b>c;c++){var d=this.children[c];d.updateBone(a),d.update(a)}},a.L=c}(window);