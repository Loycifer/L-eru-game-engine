!function(a,b){function c(){d.load.audio=function(a,b){d.system.expectedResources+=1;var c=new XMLHttpRequest,e=void 0===b?a.substr(0,a.lastIndexOf(".")):b;c.open("GET",d.system.resourcePath+d.system.soundPath+a+d.system.audioType,!0),c.responseType="arraybuffer",c.onload=function(){d.audio.context.decodeAudioData(c.response,function(b){d.sound[e]=b,d.system.loadedResources+=1,d.log("Loaded audio file "+a)},function(){d.alert("There was a problem loading "+a+".")})},c.send()},d.objects.soundFX=function(a){void 0===a&&alert("Error accessing soundbuffer "+a),this.buffer=a},d.objects.soundFX.prototype.play=function(){var a=d.audio.context.createBufferSource();a.buffer=d.sound[this.buffer];var b=d.audio.context.createPanner(),c=d.audio.context.createGain();b.connect(d.audio.soundFX),b.panningModel="equalpower",b.setPosition(0,0,0),c.connect(b),a.connect(c),a.start(0),d.log("playing sound")}}window.performance||(window.performance={}),window.performance.now||(window.performance.now=function(){return Date.now()}),Array.prototype.mapQuick=function(a){for(var b=this.length,c=0;b>c;c++)a(this[c],c);return this},Array.prototype.sortBy=function(a,b){var c=this.length;void 0===b&&(b=1);for(var d=0;c>d;d++)this[d]instanceof Array&&this[d].sortBy(a,b);this.sort(function(c,d){var e=+c[a],f=+d[a];return b*(e-f)})},Array.prototype.getRandomElement=function(){return this[Math.floor(Math.random()*this.length)]},Array.prototype.removeElement=function(a){alert(2);var b=this.indexOf(a);return-1!==b&&(alert("removed "+this[b]),this.splice(b,1)),this},Array.prototype.draw=function(a){for(var b=this.length,c=0;b>c;c++)this[c]&&this[c].draw&&this[c].draw(a)},Array.prototype.update=function(a){for(var b=this.length,c=0;b>c;c++)this[c]&&this[c].update&&this[c].update(a)},Array.prototype.handleClick=function(a,b,c){for(var d=this.length,e=d-1;e>=0;e--)if(this[e].handleClick&&this[e].handleClick(a,b,c))return!0},Math.jordanCurve=function(a,b,c){for(var d=!1,e=c.length,f=0,g=e-1;e>f;g=f++)c[f][1]>b!=c[g][1]>b&&a<(c[g][0]-c[f][0])*(b-c[f][1])/(c[g][1]-c[f][1])+c[f][0]&&(d=!d);return d},Math.log10=function(a){return Math.log(a)/Math.LN10},Math.degToRad=function(a){return a*(Math.PI/180)},Math.radToDeg=function(a){return a*(180/Math.PI)},Math.vectorX=function(a,b){switch(b){case 0:return a;case 180:return-a;case 90:case-90:return 0;default:return Math.cos(Math.degToRad(b))*a}},Math.vectorY=function(a,b){switch(b){case 0:case 180:return 0;case 90:return-a;case-90:return a;default:return Math.sin(Math.degToRad(b))*a}},Math.Vector=function(a,b){this.magnitude=a,this.direction=b},Math.Vector.prototype.addVector=function(a){var b=Math.degToRad(this.direction),c=Math.degToRad(a.direction),d=Math.cos(b)*this.magnitude,e=Math.cos(c)*a.magnitude,f=-Math.sin(b)*this.magnitude,g=-Math.sin(c)*a.magnitude,h=d+e,i=f+g,j=Math.atan(i/h),k=Math.sqrt(Math.pow(h,2)+Math.pow(i,2));this.magnitude=k,this.direction=j},Math.rotatePoint=function(a,b,c){var d=Math.cos(c),e=Math.sin(c),f=d*a+e*b,g=-(e*a)+d*b;return{x:f,y:g}};var d={};d.system={},d.objects={},d.game={},d.pipe={},d.start=function(){var a=d.game,b=d.system;a.settings(),b.setup(),a.resources(),b.setLoadScreen(),function c(){var a=d.system,b=a.currentScene,e=a.now=window.performance.now(),f=a.dt=(a.now-a.then)/1e3;f>1/a.frameCap&&(a.dt=1/a.frameCap),a.then=e,b.update(f),b.draw(),requestAnimationFrame(c)}()},d.log=function(a){console&&console.log&&console.log(a)},d.alert=function(a){window&&window.alert&&window.alert(a)},d.system={},d.system.orientation="landscape",d.system.fullscreen=!0,d.system.canvasRatio=1,d.system.timeScale=1,d.system.frameCap=30,d.system.now,d.system.then=window.performance.now(),d.system.dt=0,d.system.resourcePath="resources/",d.system.soundPath="sounds/",d.system.texturePath="textures/",d.system.expectedResources=0,d.system.loadedResources=0,d.system.width=640,d.system.height=480,d.system.canvasLocation=document.body,Object.defineProperty(d.system,"centerX",{get:function(){return d.system.width/2}}),Object.defineProperty(d.system,"centerY",{get:function(){return d.system.height/2}}),d.system.layerAlpha=1,d.system.currentScene={},d.system.previousScene={},d.scenes={},d.texture={},d.load={},d.load.texture=function(a,b){d.system.expectedResources+=1;var c=new Image,e=void 0===b?a.substr(0,a.lastIndexOf(".")):b;return c.onload=function(){d.system.loadedResources+=1,console.log("Succesfully loaded texture "+a+"."),c.onload=void 0,c.error=void 0},c.onerror=function(){d.alert("Something went wrong loading texture file "+a+".")},c.src=d.system.resourcePath+d.system.texturePath+a,d.texture[e]=c,c.complete&&c.onload(),c},d.sound={},d.music={},window.addEventListener("load",d.start),d.system.renderCanvas=[],d.system.renderContext=[],d.system.bufferCanvas=[],d.system.bufferContext=[],d.system.fxCanvas=[],d.system.fxContext=[],d.system.pixelCanvas=[],d.system.pixelContext=[],d.system.setup=function(){function a(a){void 0!==d.system.currentScene.doKeyDown&&d.system.currentScene.doKeyDown(a)}function b(a){void 0!==d.system.currentScene.doKeyUp&&d.system.currentScene.doKeyUp(a)}{var c=d.system.width,e=d.system.height;d.system.aspectRatio=c/e}try{screen.lockOrientation(d.system.orientation)}catch(f){d.log("Warning: Screen orientation could not be locked.")}d.system.renderCanvas[0]=document.createElement("canvas"),d.system.renderCanvas[0].width=c,d.system.renderCanvas[0].height=e,d.system.canvasLocation.appendChild(d.system.renderCanvas[0]),d.system.renderContext[0]=d.system.renderCanvas[0].getContext("2d"),d.system.bufferCanvas[0]=document.createElement("canvas"),d.system.bufferCanvas[0].width=c,d.system.bufferCanvas[0].height=e,d.system.bufferContext[0]=d.system.bufferCanvas[0].getContext("2d"),d.system.fxCanvas[0]=document.createElement("canvas"),d.system.fxCanvas[0].width=c,d.system.fxCanvas[0].height=e,d.system.fxContext[0]=d.system.fxCanvas[0].getContext("2d"),d.system.pixelCanvas[0]=document.createElement("canvas"),d.system.pixelCanvas[0].width=1,d.system.pixelCanvas[0].height=1,d.system.pixelContext[0]=d.system.pixelCanvas[0].getContext("2d"),Object.defineProperty(d.system,"canvasX",{get:function(){return d.system.renderCanvas[0].offsetLeft}}),Object.defineProperty(d.system,"canvasY",{get:function(){return d.system.renderCanvas[0].offsetTop}}),d.mouse.setupEventListeners(),window.addEventListener("keydown",a,!0),window.addEventListener("keyup",b,!0),d.system.fullscreen&&(d.display.autoResize(),window.addEventListener("resize",d.display.autoResize,!0))},d.system.setLoadScreen=function(){var a=d.system,b=a.width,c=a.height,e=d.objects,f="#eeeeee",g=new e.Scene;g.bgFill="#000000";var h=new e.Textbox("Ludix",b/2,c/2-75);h.alignment="center",h.backgroundFill="",h.textFill=f,h.fontSize=50,h.autoSize();var i=new e.Textbox("https://github.com/Loycifer/Ludix.js",b/2,c/2);i.alignment="center",i.textFill=f,i.backgroundFill="",i.fontSize=20,i.visible=!1,i.autoSize(),g.layers.background.addObject(h);var j={state:"loading",timer:4};j.update=function(b){var c=this.timer;switch(this.state){case"loading":a.expectedResources===a.loadedResources&&(this.state="ready",i.visible=!0);break;case"ready":0>=c&&(this.timer=3,this.state="fadeOut"),k.alpha>0&&(k.alpha-=.5*b),k.alpha<0&&(k.alpha=0),l.alpha>0&&(l.alpha-=.5*b),l.alpha<0&&(l.alpha=0),this.timer-=1*b;break;case"fadeOut":0>=c&&d.game.main(),h.alpha>0&&(h.alpha-=1*b),h.alpha<0&&(h.alpha=0),i.alpha>0&&(i.alpha-=1*b),i.alpha<0&&(i.alpha=0),this.timer-=1*b}};var k={alpha:1};k.draw=function(d){var e=.25*b,g=a.loadedResources/a.expectedResources;d.globalAlpha=this.alpha,d.beginPath(),d.lineWidth=3,d.strokeStyle=f,d.fillStyle=f,d.rect(e,c/2,2*e,30),d.stroke(),d.fillRect(e+4,c/2+4,g*(2*e-8),22)},k.update=function(){};var l={alpha:1};l.draw=function(a){if(this.alpha>0){a.globalAlpha=this.alpha,a.lineWidth=1,a.strokeStyle="#000000",a.beginPath();for(var d=.5,e=c,f=b;e>d;d+=2)a.moveTo(0,d),a.lineTo(f,d);a.stroke()}},g.layers.background.addObject(k),g.layers.background.addObject(i),g.layers.background.addObject(j),g.layers.background.addObject(l),g.setScene()},d.mouse={},d.mouse.x=0,d.mouse.y=0,d.mouse.buttons=[],d.mouse.buttons[0]={name:"left",isDown:!1,lastDown:{x:0,y:0}},d.mouse.buttons[1]={name:"middle",isDown:!1,lastDown:{x:0,y:0}},d.mouse.buttons[2]={name:"right",isDown:!1,lastDown:{x:0,y:0}},d.mouse.touchEnabled=!1,d.mouse.reset=function(){for(var a=0;3>a;a++){var b=this.buttons[a];b.isDown=!1,b.lastDown.x=0,b.lastDown.y=0}},d.system.handleClick=function(a){var b=0,c=0,e=a.type;if(a.targetTouches){b=(a.targetTouches[0].pageX-d.system.canvasX)/d.system.canvasRatio,c=(a.targetTouches[0].pageY-d.system.canvasY)/d.system.canvasRatio;var f=d.mouse.buttons[0];"touchstart"===e&&(f.isDown=!0,f.lastDown.x=b,f.lastDown.y=c),"touchend"===e&&(f.isDown=!1)}else{var f=d.mouse.buttons[a.button];b=(a.pageX-d.system.canvasX)/d.system.canvasRatio,c=(a.pageY-d.system.canvasY)/d.system.canvasRatio,"mousedown"===e&&(f.isDown=!0,f.lastDown.x=b,f.lastDown.y=c),"mouseup"===e&&(f.isDown=!1)}d.system.currentScene.handleClick&&"left"===f.name&&d.system.currentScene.handleClick(b,c,a),a.preventDefault()},d.system.setMouseCoords=function(a){"touchmove"!==a.type?(d.mouse.x=(a.pageX-d.system.canvasX)/d.system.canvasRatio,d.mouse.y=(a.pageY-d.system.canvasY)/d.system.canvasRatio):(d.mouse.x=(a.targetTouches[0].pageX-d.system.canvasX)/d.system.canvasRatio,d.mouse.y=(a.targetTouches[0].pageY-d.system.canvasY)/d.system.canvasRatio)},d.mouse.setupEventListeners=function(){"ontouchstart"in document.documentElement?(d.mouse.touchEnabled=!0,d.system.renderCanvas[0].addEventListener("touchstart",d.system.handleClick),d.system.renderCanvas[0].addEventListener("touchmove",d.system.setMouseCoords),d.system.renderCanvas[0].addEventListener("touchend",d.system.handleClick)):(d.system.renderCanvas[0].addEventListener("mousedown",d.system.handleClick),d.system.renderCanvas[0].addEventListener("mousemove",d.system.setMouseCoords),d.system.renderCanvas[0].addEventListener("mouseup",d.system.handleClick))},d.display={get width(){return d.system.renderCanvas[0].style.offsetWidth},set width(a){d.system.renderCanvas[0].style.width=a},get height(){return d.system.renderCanvas[0].style.height},set height(a){d.system.renderCanvas[0].style.height=a}},d.display.autoResize=function(){var a=window.innerWidth,b=window.innerHeight,c=d.system.width,e=d.system.height,f=a/b;f>=d.system.aspectRatio?d.system.canvasRatio=b/e:f<d.system.aspectRatio&&(d.system.canvasRatio=a/c),d.system.renderCanvas[0].style.width=c*d.system.canvasRatio+"px",d.system.renderCanvas[0].style.height=e*d.system.canvasRatio+"px",document.body.style.width="100%",document.body.style.height=Math.floor(b)+"px"},d.system.checkAudio=function(){var a=document.createElement("audio");a.canPlayType("audio/ogg")?(d.system.audioType=".ogg",d.log("Using .ogg files")):a.canPlayType("audio/mp4")?(d.system.audioType=".m4a",d.log("Using .m4a files")):a.canPlayType("audio/wav")?(d.system.audioType=".wav",d.log("Using .wav files")):d.alert("Your browser doesn't support .wav, .ogg, or .m4a audio files.")},d.system.checkAudio(),d.audio={},d.audio.context={};try{window.AudioContext=window.AudioContext||window.webkitAudioContext,d.audio.context=new AudioContext,d.audio.compressor=d.audio.context.createDynamicsCompressor(),d.audio.compressor.connect(d.audio.context.destination),d.audio.masterGain=d.audio.context.createGain(),d.audio.masterGain.connect(d.audio.compressor),d.audio.masterGain.gain.value=1,d.audio.soundFX=d.audio.context.createGain(),d.audio.soundFX.connect(d.audio.masterGain),c()}catch(e){alert("Web Audio API is not supported in this browser")}d.objects.Sprite=function(a,b){this.animations={idle:[]},this.animations.idle[0]={img:d.texture[a],length:1e3},this.animations.idle[0].img&&d.log("Created Sprite from texture '"+a+"'."),this.texture=d.texture[a],this.texture&&this.texture.width>0&&(this.width=this.texture.width,this.height=this.texture.height,d.log("Setting Sprite dimensions to "+this.width+" by "+this.height+".")),this.handle={x:0,y:0},this.offset={x:0,y:0},this.scale={x:1,y:1};for(var c in b)b.hasOwnProperty(c)&&(d.log("Adding property "+c+" to Sprite object with with value "+JSON.stringify(b[c])+"."),this[c]=b[c]);Object.defineProperty(this,"center",{get:function(){return{x:this.width/2,y:this.height/2}}.bind(this)}),this.nudeTop=0,this.nudeLeft=0,this.nudeRight=this.nudeLeft+this.width,this.nudeBottom=this.nudeTop+this.height,this.nudeTopLeft=[this.nudeLeft,this.nudeTop],this.nudeTopRight=[this.nudeRight,this.nudeTop],this.nudeBottomLeft=[this.nudeLeft,this.nudeBottom],this.nudeBottomRight=[this.nudeRight,this.nudeBottom],this.nudeVertices=[this.nudeTopLeft,this.nudeTopRight,this.nudeBottomRight,this.nudeBottomLeft],this.vertices=new Array(this.nudeVertices.length),this.rotationAccel=0,this.accelDirection=0,this.nextX=this.x,this.nextY=this.y,this.nextSpeedX=this.speedX,this.nextSpeedY=this.speedY,this.wrapX=!0,this.wrapY=!1,this.boundingType="rect",this.blendMode="",this.onClick=function(){},this.currentAnimation="idle",this.currentFrame=0,this.animationTimer,this.updateCommands={},this.drawCommands={},this.gravity=0,this.g=1e3,this.direction=-Math.PI/2,this.v=0,this.y0=500-this.y,this.energy=this.y0,this.time=0,this.bounces=0,this.landingTime=(this.v*Math.sin(this.direction)+Math.sqrt(Math.pow(this.v*Math.sin(this.direction),2)+2*this.g*this.y0))/this.g},d.objects.Sprite.prototype.x=0,d.objects.Sprite.prototype.y=0,d.objects.Sprite.prototype.z=0,d.objects.Sprite.prototype.width=0,d.objects.Sprite.prototype.height=0,d.objects.Sprite.prototype.angle=0,d.objects.Sprite.prototype.rotation=0,d.objects.Sprite.prototype.alpha=1,d.objects.Sprite.prototype.speedX=0,d.objects.Sprite.prototype.speedY=0,d.objects.Sprite.prototype.accelX=0,d.objects.Sprite.prototype.accelY=0,d.objects.Sprite.prototype.visible=!0,d.objects.Sprite.prototype.isClickable=!0,d.objects.Sprite.prototype.setHandleXY=function(a,b){this.handle={x:a,y:b}},d.objects.Sprite.prototype.setScale=function(a){this.scale={x:a,y:a}},d.objects.Sprite.prototype.multiplyScale=function(a){this.scale={x:a*this.scale.x,y:a*this.scale.y}},d.objects.Sprite.prototype.flipHorizontal=function(){this.scale.x*=-1},d.objects.Sprite.prototype.flipVertical=function(){this.scale.y*=-1},d.objects.Sprite.prototype.getX=function(){return this.x+this.offset.x},d.objects.Sprite.prototype.getY=function(){return this.y+this.offset.y},d.objects.Sprite.prototype.getScreenX=function(){var a=d.system.currentScene;return this.x+this.offset.x-a.camera.x*a.activeLayer.scrollRateX},d.objects.Sprite.prototype.getScreenY=function(){var a=d.system.currentScene;return this.y+this.offset.y-a.camera.y*a.activeLayer.scrollRateY},d.objects.Sprite.prototype.autoDraw=function(a){if(this.visible&&!(this.alpha<=0)){var b=this.angle,c=this.getScreenX(),d=this.getScreenY(),e=this.scale;a.globalAlpha=this.alpha,a.save(),a.translate(c,d),a.scale(e.x,e.y),a.rotate(-b),a.drawImage(this.animations[this.currentAnimation][this.currentFrame].img,-this.handle.x,-this.handle.y),a.restore()}},d.objects.Sprite.prototype.draw=d.objects.Sprite.prototype.autoDraw,d.objects.Sprite.prototype.autoDrawCustom=function(a,b){a.globalAlpha=b&&void 0!==b.opacity?b.opacity:this.alpha,this.alpha>0&&this.visible&&(0!==this.angle?(a.save(),a.translate(this.x,this.y),a.rotate(-this.angle),a.drawImage(b&&void 0!==b.texture?b.texture:this.animations.idle[this.currentFrame].img,-this.handle.x,-this.handle.y),a.restore()):a.drawImage(b&&void 0!==b.texture?b.texture:this.animations.idle[this.currentFrame].img,this.x-this.handle.x,this.y-this.handle.y))},d.objects.Sprite.prototype.drawBoundingBox=function(a){a.beginPath(),this.getVertices(),a.moveTo(this.vertices[3][0],this.vertices[3][1]);for(var b=0;4>b;b++)a.lineTo(this.vertices[b][0],this.vertices[b][1]);a.closePath(),a.strokeStyle="#FFFFFF",a.lineWidth=2,a.stroke()},d.objects.Sprite.prototype.update2=function(a){this.autoUpdate(a)},d.objects.Sprite.prototype.autoUpdate=function(a){var b=d.system.timeScale;this.speedX+=this.accelX*a*b,this.speedY+=this.accelY*a*b,this.x+=this.speedX*a*b,this.y+=this.speedY*a*b,this.rotation+=this.rotationAccel*a*b,this.angle+=this.rotation*a*b},d.objects.Sprite.prototype.handleClick=function(a,b,c){if(this.isClickable){var d=this.scale,e=this.getScreenX(),f=this.getScreenY();if(0===this.angle){var g=e-d.x*this.handle.x,h=g+d.x*this.width,i=f-d.y*this.handle.y,j=i+d.y*this.height;if(g>h){var k=g;g=h,h=k}if(i>j){var k=i;i=j,j=k}if(a>=g&&h>=a&&b>=i&&j>=b&&this.isClickedPrecise(a,b)&&"mousedown"===c.type)return this.onClick(a,b,c),!0}else if(0!==this.angle&&Math.jordanCurve(a,b,this.getVertices())&&this.isClickedPrecise(a,b)&&"mousedown"===c.type)return this.onClick(a,b,c),!0}},d.objects.Sprite.prototype.isClickedPrecise=function(a,b){var c=d.system.pixelContext[0];c.clearRect(-1,-1,3,3),c.save(),c.translate(-a,-b),this.autoDraw(c),c.restore();var e=c.getImageData(0,0,1,1).data;return 0!==e[3]},d.objects.Sprite.prototype.getSpeedX=function(){return Math.vectorX(this.speed,this.direction)},d.objects.Sprite.prototype.getSpeedY=function(){return Math.vectorY(this.speed,this.direction)},d.objects.Sprite.prototype.applyForce=function(a,b){var c=this.getSpeedX(),d=this.getSpeedY(),e=Math.vectorX(a,b),f=Math.vectorY(a,b),g=c+e,h=d+f,i=Math.pow(Math.pow(g,2)+Math.pow(h,2),.5),j=Math.radToDeg(Math.atan2(-h,g));this.direction=j,this.speed=i},d.objects.Sprite.prototype.moveTo=function(a){this.x=a.x,this.y=a.y},d.objects.Sprite.prototype.moveToX=function(a){this.x=a},d.objects.Sprite.prototype.move=function(a){this.x+=a.x,this.y+=a.y},d.objects.Sprite.prototype.moveX=function(a){this.move({x:a,y:0})},d.objects.Sprite.prototype.moveY=function(a){this.move({x:0,y:a})},d.objects.Sprite.prototype.centerHandle=function(){this.handle={x:this.center.x,y:this.center.y}},d.objects.Sprite.prototype.pushProperties=function(a,b){for(var c=b.length,d=0;c>d;d++)a[b[d]]=this[b[d]]},d.objects.Sprite.prototype.pushPosition=function(a){a.x=this.x,a.y=this.y,a.offset={x:this.offset.x,y:this.offset.y}},d.objects.Sprite.prototype.getVertices=function(){var a=window.Math,b=this.getScreenX()+this.offset.x,c=this.getScreenY()+this.offset.y,d=this.nudeVertices.length,e=this.angle,f=this.scale;if(0!==e)for(var g=0;d>g;g++)this.vertices[g]=[(this.nudeVertices[g][0]-this.handle.x)*a.cos(-e)-(this.nudeVertices[g][1]-this.handle.y)*a.sin(-e),(this.nudeVertices[g][0]-this.handle.x)*a.sin(-e)+(this.nudeVertices[g][1]-this.handle.y)*a.cos(-e)];else for(var g=0;d>g;g++)this.vertices[g]=[this.nudeVertices[g][0]-this.handle.x,this.nudeVertices[g][1]-this.handle.y];return this.vertices.mapQuick(function(a){a[0]=a[0]*f.x+b,a[1]=a[1]*f.y+c}),this.vertices},d.Frame=function(a,b){this.img=d.texture[a],this.length=b},d.Animation=function(){},d.objects.Sprite.prototype.experimentalUpdate=function(a){var b=b;this.time+=a*b.system.timeScale;var c=c;this.time>=this.landingTime&&(this.energy<1&&(this.energy=0),this.direction=c.PI/2,this.y0=0,this.v=c.sqrt(2*this.g*this.energy/c.pow(c.sin(this.direction),2)),this.time-=this.landingTime,this.landingTime=(this.v*c.sin(this.direction)+c.sqrt(c.pow(this.v*c.sin(this.direction),2)+2*this.g*this.y0))/this.g),this.y=this.landingTime<a*b.system.timeScale?500:500-this.y0-(this.v*c.sin(this.direction)*this.time-this.g*this.time*this.time/2),this.y>=500&&(this.y=500),this.nextY=this.y,this.nextSpeedX+=this.accelX*a*b.system.timeScale,this.nextX+=this.nextSpeedX*b.system.dt*b.system.timeScale,this.nextX>=800&&(this.nextSpeedX=-this.speedX,this.speedX=-this.speedX,this.nextX=799),this.nextX<=49&&(this.nextSpeedX=-this.speedX,this.speedX=-this.speedX,this.nextX=50),this.x=this.nextX,this.speedX=this.nextSpeedX},d.objects.Layer=function(a){this.name=a,this.sorted=!1,this.sortBy=["z"],this.sortOrder=[1],this.objects=[],this.targetContext=d.system.bufferContext[0],this.layerAlpha=1,this.isClickable=!0,this.scrollRateX=1,this.scrollRateY=1},d.objects.Layer.prototype.draw=function(){this.autoDraw()},d.objects.Layer.prototype.autoDraw=function(){this.objects.draw(this.targetContext)},d.objects.Layer.prototype.update=function(a){this.autoUpdate(a)},d.objects.Layer.prototype.autoUpdate=function(a){if(this.objects.update(a),this.sorted){length=this.sortBy.length;for(var b=0;b<length;b++)this.objects.sortBy(this.sortBy[b],this.sortOrder[b])}},d.objects.Layer.prototype.handleClick=function(a,b,c){this.isClickable&&this.objects.handleClick(a,b,c)},d.objects.Layer.prototype.addObject=function(a){this.objects.push(a)},d.objects.Layer.prototype.addObjects=function(){for(var a=arguments.length,b=0;a>b;b++)this.addObject(arguments[b])},d.objects.Scene=function(a){this.name=a,d.scenes[a]=this,this.layers={background:new d.objects.Layer("background")},this.layerOrder=["background"],this.bgFill="blueviolet",this.motionBlur=1,this.keymap={},this.activeLayer={},this.camera={x:0,y:0,angle:0,zoom:1}},d.objects.Scene.prototype.update=function(a){return this.autoUpdate(a),this},d.objects.Scene.prototype.doKeyDown=function(a){void 0!==this.keymap.doKeyDown&&this.keymap.doKeyDown(a)},d.objects.Scene.prototype.doKeyUp=function(a){void 0!==this.keymap.doKeyUp&&this.keymap.doKeyUp(a)},d.objects.Scene.prototype.autoUpdate=function(a){for(var b=this.layerOrder,c=b.length,d=0;c>d;d++){var e=this.layers[b[d]];this.activeLayer=e,e.update(a)}return this},d.objects.Scene.prototype.autoDraw=function(){var a=d.system,b=a.bufferContext[0],c=a.renderContext[0],e=a.width,f=a.height;b.fillStyle=this.bgFill,b.fillRect(0,0,e,f);for(var g=this.layerOrder,h=g.length,i=0;h>i;i++){var j=this.layers[g[i]];this.activeLayer=j,j.draw()}b.globalAlpha=1,c.globalAlpha=this.motionBlur,c.drawImage(a.bufferCanvas[0],0,0,e,f)},d.objects.Scene.prototype.draw=d.objects.Scene.prototype.autoDraw,d.objects.Scene.prototype.addLayer=function(a){var b=new d.objects.Layer(a);return this.layers[a]=b,this.layerOrder.push(a),b},d.objects.Scene.prototype.addLayerObject=function(a){this.layers[a.name]=a,this.layerOrder.push(a.name)},d.objects.Scene.prototype.addObjectToLayer=function(a,b){return this.layers[b].addObject(a),this},d.objects.Scene.prototype.handleClick=function(a,b,c){for(var d=this.layerOrder,e=d.length,f=0;e>f;f++){var g=this.layers[d[f]];this.activeLayer=g,g.handleClick(a,b,c)}},d.objects.Scene.prototype.transition={},d.objects.Scene.prototype.transition.fadeToColor=function(a,b,c,e,f,g){d.transitions.fadeToColor.play(d.system.currentScene,a,b,c,e,f,g)},d.objects.Scene.prototype.transition.fadeToBlack=function(a,b,c,e,f){d.transitions.fadeToColor.play(d.system.currentScene,a,b,c,e,"#000000",f)},d.objects.Scene.prototype.transition.instant=function(a,b){d.transitions.instant.play(d.system.currentScene,a,b)},d.objects.Scene.prototype.setScene=function(){var a=d.system;return a.previousScene=a.currentScene,a.currentScene=this,this},d.objects.Textbox=function(a,b,c,d,e){this.width=void 0===d?200:d,this.height=e,this.words=void 0===a?[]:a.split(" "),this.textArray=[],Object.defineProperty(this,"text",{set:function(a){this.words=a.split(" "),this.wrapText()}.bind(this),get:function(){return this.words.join(" ")}.bind(this)}),this.x=void 0===b?0:b,this.y=void 0===c?0:c,this.alpha=1,this.font="Times",this.fontSize=30,this.lineSpacing=1,this.handle={},this.handle.x=0,this.handle.y=0,this.angle=0,this.speedX=0,this.speedY=0,this.accelX=0,this.accelY=0,this.rotation=0,this.textFill="#000000",this.wrap=!0,this.alignment="left",this.alignmentY="top",this.backgroundFill="#FFFFFF",this.borderFill="",this.borderWidth=0,this.marginLeft=5,this.marginTop=5,this.marginRight=5,this.marginBottom=5,this.visible=!0,this.isClickable=!0},d.objects.Textbox.prototype.draw=function(a){this.autoDraw(a)},d.objects.Textbox.prototype.autoDraw=function(a){if(this.visible){a.globalAlpha=this.alpha;var b=""!==this.backgroundFill&&this.borderWodth>0;a.textAlign="left",a.font=this.fontSize+"px "+this.font,this.height||(this.height=this.fontSize);var c=this.textArray.length;if(0!==this.angle){var d=this.angle;a.save(),a.translate(this.x,this.y),a.rotate(-d),b&&(a.beginPath(),a.rect(-this.handle.x,-this.handle.y,this.width+this.marginLeft+this.marginRight,this.height+this.marginTop+this.marginBottom+this.fontSize*(c-1)*this.lineSpacing),""!==this.backgroundFill&&(a.fillStyle=this.backgroundFill,a.fill()),this.borderWidth>0&&(a.strokeStyle=this.borderFill,a.lineWidth=this.borderWidth,a.stroke())),a.fillStyle=this.textFill,a.textBaseline="bottom";for(var e=0;c>e;e++)a.fillText(this.textArray[e],this.marginLeft-this.handle.x,this.marginTop+this.fontSize-this.handle.y+this.fontSize*e*this.lineSpacing);a.restore()}else{b&&(a.beginPath(),a.rect(this.x-this.handle.x,this.y-this.handle.y,this.width+this.marginLeft+this.marginRight,this.height+this.marginTop+this.marginBottom+this.fontSize*(c-1)*this.lineSpacing),""!==this.backgroundFill&&(a.fillStyle=this.backgroundFill,a.fill()),this.borderWidth>0&&(a.strokeStyle=this.borderFill,a.lineWidth=this.borderWidth,a.stroke())),a.fillStyle=this.textFill,a.textBaseline="bottom";for(var e=0;c>e;e++)a.fillText(this.textArray[e],this.x+this.marginLeft-this.handle.x,this.y+this.marginTop+this.fontSize-this.handle.y+this.fontSize*e*this.lineSpacing)}}},d.objects.Textbox.prototype.update=function(a){this.autoUpdate(a)},d.objects.Textbox.prototype.autoUpdate=function(){},d.objects.Textbox.prototype.autoSize=function(){this.autoSizeX(),this.autoSizeY(),this.wrapText()},d.objects.Textbox.prototype.autoSizeX=function(){this.width=this.getTextWidth(),this.realign()},d.objects.Textbox.prototype.autoSizeY=function(){this.height=this.fontSize},d.objects.Textbox.prototype.wrapText=function(){var a=this.words.length;this.textArray=[];for(var b=0,c="",d=this.width,e=0;a>e;e++){var f=this.getTextWidth(c);0===f?c=this.words[e]:this.getTextWidth(c+" "+this.words[e])<=d?c+=" "+this.words[e]:(this.textArray[b]=c,b++,c=this.words[e])}this.textArray[b]=c},d.objects.Textbox.prototype.getTextWidth=function(a){var b=d.system.bufferContext[0];if(b.font=this.fontSize+"px "+this.font,""===a)return 0;var c=b.measureText(a?a:this.text);return c.width},d.objects.Textbox.prototype.getTotalWidth=function(){return this.width+this.marginLeft+this.marginRight},d.objects.Textbox.prototype.getTotalHeight=function(){return this.height+this.marginTop+this.marginBottom},d.objects.Textbox.prototype.realign=function(){this[this.alignment](),this[this.alignmentY]()},d.objects.Textbox.prototype.center=function(){return this.handle.x=this.getTotalWidth()/2,this.alignment="center",this},d.objects.Textbox.prototype.centerY=function(){return this.handle.y=this.getTotalHeight()/2,this.alignmentY="centerY",this},d.objects.Textbox.prototype.top=function(){return this.handle.y=0,this.alignmentY="top",this},d.objects.Textbox.prototype.bottom=function(){return this.handle.y=this.getTotalHeight(),this.alignmentY="bottom",this},d.objects.Textbox.prototype.left=function(){return this.handle.x=0,this.alignment="left",this},d.objects.Textbox.prototype.right=function(){return this.handle.x=this.getTotalWidth(),this.alignment="right",this},d.objects.Textbox.prototype.setMargins=function(){switch(arguments.length){case 1:this.marginLeft=this.marginTop=this.marginRight=this.marginBottom=arguments[0];break;case 2:this.marginTop=this.marginBottom=arguments[0],this.marginLeft=this.marginRight=arguments[1];break;case 3:this.marginTop=arguments[0],this.marginRight=this.marginLeft=arguments[1],this.marginBottom=arguments[2];break;case 4:this.marginTop=arguments[0],this.marginRight=arguments[1],this.marginBottom=arguments[2],this.marginLeft=arguments[3];break;default:alert("Textbox.setMargins() called with wrong number of arguments.")}return this.realign(),this},d.objects.Textbox.prototype.handleClick=function(a,b){return this.isClickable&&(0===this.angle&&a>=this.x-this.handle.x&&a<=this.x+this.width+this.marginLeft+this.marginRight-this.handle.x&&b>=this.y-this.handle.y&&b<=this.y+this.height+this.marginTop+this.marginBottom-this.handle.y+this.fontSize*(this.textArray.length-1)*this.lineSpacing||0!==this.angle&&Math.jordanCurve(a,b,this.getVertices()))?(this.onClick(),!0):void 0},d.objects.Textbox.prototype.getVertices=function(){var a=window.Math,b=this.x,c=this.y,d=0-this.handle.y,e=0-this.handle.x,f=e+this.width+this.marginLeft+this.marginRight,g=d+this.height+this.marginTop+this.marginBottom+this.fontSize*(this.textArray.length-1)*this.lineSpacing,h=[[e,d],[f,d],[f,g],[e,g]];if(0!==this.angle)for(var i=h.length,j=0;i>j;j++)h[j]=[h[j][0]*a.cos(-this.angle)-h[j][1]*a.sin(-this.angle),h[j][0]*a.sin(-this.angle)+h[j][1]*a.cos(-this.angle)];return h.mapQuick(function(a){a[0]+=b,a[1]+=c}),h},d.transitions={},d.transitions.instant={},d.transitions.instant.play=function(a,b,c){a.exit&&a.exit(),c&&c(b),d.system.currentScene=b},d.transitions.fadeToColor={lastScene:{},nextScreen:{},timer:0,state:"start"},d.transitions.fadeToColor.play=function(a,b,c,e,f,g,h){this.lastScene=a,this.nextScene=b,this.camera=a.camera,this.currentScene=a,this.activeLayer=a.activeLayer,this.fadeOut=c,this.pause=e,this.fadeIn=f,this.timer=c,this.state="start",this.color=g||"#000000",this.callback=h||function(){},d.system.currentScene=this},d.transitions.fadeToColor.update=function(a){switch(this.state){case"start":this.timer=this.fadeOut,this.lastScene.update(a),this.state="fadeOut";break;case"fadeOut":this.timer-=a,this.lastScene.update(a),this.timer<=0&&(this.timer=this.pause,this.callback(this.nextScene),this.state="pause");break;case"pause":this.timer-=a,this.timer<=0&&(this.camera=this.nextScene.camera,this.timer=this.fadeIn,this.state="fadeIn");break;case"fadeIn":this.timer-=a,this.nextScene.update(a),this.timer<=0&&(d.system.currentScene=this.nextScene);break;default:alert("Hey!")}},d.transitions.fadeToColor.draw=function(){switch(this.state){case"start":case"fadeOut":this.lastScene.draw(),d.system.renderContext[0].fillStyle=this.color,d.system.renderContext[0].globalAlpha=1-this.timer/this.fadeOut,d.system.renderContext[0].fillRect(0,0,d.system.width,d.system.height);break;case"pause":d.system.renderContext[0].fillStyle=this.color,d.system.renderContext[0].globalAlpha=1,d.system.renderContext[0].fillRect(0,0,d.system.width,d.system.height);break;case"fadeIn":this.nextScene.draw(),d.system.renderContext[0].fillStyle=this.color,d.system.renderContext[0].globalAlpha=this.timer/this.fadeIn,d.system.renderContext[0].fillRect(0,0,d.system.width,d.system.height);break;default:alert("hey!")}},d.input={},d.input.keyCodeFromString=function(a){var b=a.toUpperCase().replace(" ","");if(b.match(/^[A-Z0-9]$/))return b.charCodeAt(0);if(0===b.indexOf("NUMPAD"))return 96+parseInt(b.charAt(b.length-1));if(0===b.indexOf("F"))return 111+parseInt(b.replace("F",""));switch(b){case"MULTIPLY":return 106;case"ADD":return 107;case"ENTER":return 13;case"SUBTRACT":return 109;case"DECIMAL":return 110;case"DIVIDE":return 111;case"BACKSPACE":case"BACK":return 8;case"TAB":return 9;case"SHIFT":return 16;case"CONTROL":case"CTRL":return 17;case"CAPS":case"CAPSLOCK":return 20;case"ESC":case"ESCAPE":return 27;case"SPACE":case"SPACEBAR":return 32;case"PGUP":case"PAGEUP":return 33;case"PGDN":case"PAGEDOWN":return 34;case"END":return 35;case"HOME":return 36;case"LEFT":case"LEFTARROW":return 37;case"UP":case"UPARROW":return 38;case"RIGHT":case"RIGHTARROW":return 39;case"DOWN":case"DOWNARROW":return 40;case"INSERT":return 45;case"DELETE":return 46;case"NUMLOCK":return 144;case"SCRLK":case"SCROLLLOCK":return 145;case"PAUSE":case"PAUSEBREAK":return 19;case";":case":":return 186;case"=":case"+":return 187;case"-":case"_":return 198;case"/":case"?":return 191;case"~":case"`":return 192;case"[":case"{":return 219;case"\\":case"|":case"BACKSLASH":return 220;case"]":case"}":return 221;case"'":case'"':case"QUOTE":case"QUOTES":return 222;case",":case"<":return 188;case".":case">":return 190;default:alert("'"+a+"' is not a valid key identifier.")}},d.input.Keymap=function(){this.bindings={}},d.input.Keymap.prototype.doKeyDown=function(a){var b=a.keyCode,c=this.bindings;c[b]&&c[b].keydown&&c[b].keydown()
},d.input.Keymap.prototype.doKeyUp=function(a){var b=a.keyCode,c=this.bindings;c[b]&&c[b].keyup&&c[b].keyup()},d.input.Keymap.prototype.bindKey=function(a,b,c){this.bindKeyCode(d.input.keyCodeFromString(a),b,c)},d.input.Keymap.prototype.bindKeyCode=function(a,b,c){this.bindings[a]||(this.bindings[a]={}),this.bindings[a][b]=c},d.objects.Bone=function(a,b){d.objects.Sprite.call(this,a,b),this.inheritPosition=!0,this.inheritAngle=!0,this.inheritScale=!0,this.joint={x:0,y:0},this.relAngle=0,this.children=[]},d.objects.Bone.prototype=new d.objects.Sprite,d.objects.Bone.constructor=d.objects.Bone,d.objects.Bone.prototype.draw=function(a){this.autoDraw(a)},d.objects.Bone.prototype.updateBone=function(a){var b=this.parent;if(this.inheritScale){var c=b.scale;this.scale={x:c.x,y:c.y}}if(this.inheritPosition){var d=b.x,e=b.y,f=this.parent.scale,g=this.joint.x-b.handle.x,h=this.joint.y-b.handle.y;if(0===b.angle)this.x=d+f.x*(this.joint.x-b.handle.x),this.y=e+f.y*(this.joint.y-b.handle.y);else{var i=Math.rotatePoint(g,h,this.parent.angle);this.x=i.x*f.x+d,this.y=i.y*f.y+e}}this.inheritAngle&&(this.angle=this.relAngle+b.angle);for(var j=this.children.length,k=0;j>k;k++)this.children[k].updateBone(a),this.children[k].update(a)},d.objects.Skeleton=function(a,b){d.objects.Sprite.call(this,a,b),this.children=[],this.bones={},this.drawOrder=[this]},d.objects.Skeleton.prototype=new d.objects.Sprite,d.objects.Skeleton.constructor=d.objects.Skeleton,d.objects.Skeleton.prototype.handleClick=function(a,b,c){for(var e=this.drawOrder.length,f=e-1;f>=0;f--){var g,h=this.drawOrder[f];if(g=this!==h?h.handleClick(a,b,c):d.objects.Sprite.prototype.handleClick.call(this.drawOrder[f],a,b,c))return!0}},d.objects.Skeleton.prototype.addBone=function(a,b){var c=new d.objects.Bone(a);return c.name=b,c.master=this,c.parent=this,this.children.push(c),this.bones[b]=c,this.drawOrder.push(c),c},d.objects.Bone.prototype.addBone=function(a,b){var c=new d.objects.Bone(a);return c.name=b,c.master=this.master,c.parent=this,this.children.push(c),this.master.bones[b]=c,this.master.drawOrder.push(c),c},d.objects.Skeleton.prototype.draw=function(a){for(var b=this.drawOrder.length,c=0;b>c;c++){var d=this.drawOrder[c];this===d?(this.autoDraw(a),this.drawBoundingBox(a)):this.drawOrder[c].draw(a)}},d.objects.Skeleton.prototype.update=function(a){this.updateBones(a)},d.objects.Skeleton.prototype.updateBones=function(a){for(var b=this.children.length,c=0;b>c;c++){var d=this.children[c];d.updateBone(a),d.update(a)}},d.objects.Timeline=function(){this.paused=!0,this.timer=0,this.length=0,this.eventList=[],this.nextEvent=0,this.preserveEvents=!0,this.stopAfterEvent=6,this.stopAtTime=0},d.objects.Timeline.prototype.update=function(a){if(!this.paused){var b=this.eventList.length;for(this.timer+=a;this.nextEvent<b&&this.timer>=this.eventList[this.nextEvent][0];)this.eventList[this.nextEvent][1](),this.nextEvent++,0!==this.stopAfterEvent&&this.nextEvent>this.stopAfterEvent-1&&(this.paused=!0)}},d.objects.Timeline.prototype.addEvent=function(a,b){var c=this.eventList,d=this.eventList.length;if(0===d||c[d-1][0]<=a)return c.push([a,b]),this;for(var e=d-1;e>=0;e--){if(0===e)return c.unshift([a,b]),this;if(a<c[e][0]&&a>=c[e-1][0])return c.splice(e,0,[a,b]),this}},d.objects.Timeline.prototype.play=function(){this.paused=!1},d.objects.Timeline.prototype.pause=function(){this.paused=!0},d.objects.Timeline.prototype.togglePause=function(){this.paused=!this.paused},d.objects.Timeline.prototype.reset=function(){this.paused=!0,this.timer=0,this.nextEvent=0},a[b]=d}(window,"L");